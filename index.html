<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castastics Land: Restored</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: white; font-family: sans-serif; overflow: hidden; touch-action: manipulation; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; }
        .active { display: flex; }

        /* RESTORED STORY SCREEN WITH IMAGE */
        #story-screen { 
            background: url('castastics_killer.png') center/cover; 
            background-color: #000; 
        }
        .dialogue-box { 
            position: absolute; bottom: 30px; width: 90%; 
            background: rgba(0, 0, 0, 0.9); border: 2px solid #00d4ff; border-radius: 15px;
            padding: 20px; box-shadow: 0 0 20px #00d4ff; box-sizing: border-box;
        }

        /* ARENA & VFX */
        #arena { 
            width: 100%; height: 350px; position: relative; overflow: hidden;
            background: linear-gradient(#1a1a2e, #16213e);
            border-bottom: 8px solid #00d4ff; display: flex; justify-content: space-around; align-items: flex-end;
        }
        #vfx-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events:none; z-index: 10; }

        .sprite { width: 130px; height: 130px; background-size: contain; background-repeat: no-repeat; background-position: bottom; transition: 0.2s; z-index: 5; }
        .btn { background: #1a1a2e; border: 2px solid #00d4ff; color: white; padding: 12px; margin: 4px; width: 85%; border-radius: 12px; font-weight: bold; }
        .ult-btn { border-color: gold; color: gold; }
        .heal-btn { border-color: #00ff88; color: #00ff88; }
        .used { opacity: 0.3; border-color: #444 !important; color: #444 !important; }
        
        .locked { opacity: 0.3; border-color: #444; }
        .hp-bar { width: 90%; height: 12px; background: #333; border-radius: 6px; margin: 5px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; transition: 0.4s; }
        
        .flash { background: white !important; transition: 0.1s; }
        .heal-flash { background: #00ff88 !important; transition: 0.2s; }
        @keyframes shake { 0% { transform: translate(0); } 25% { transform: translate(5px, 5px); } 50% { transform: translate(-5px, -5px); } 100% { transform: translate(0); } }
        .shake { animation: shake 0.2s infinite; }
    </style>
</head>
<body>

<div id="story-screen" class="screen">
    <div class="dialogue-box">
        <p id="story-text" style="font-size: 18px; line-height: 1.4; min-height: 50px;"></p>
        <button class="btn" onclick="nextStory()" style="width: auto; float: right;">Next</button>
    </div>
</div>

<div id="menu" class="screen">
    <h1 style="color:#00d4ff">CASTASTICS LAND</h1>
    <div id="lvl-list" style="width:100%; display: flex; flex-direction: column; align-items: center;"></div>
    <button class="btn" style="width: 50%; margin-top: 20px; font-size: 10px;" onclick="resetProgress()">RESET PROGRESS</button>
</div>

<div id="battle" class="screen">
    <div id="b-name" style="color:#ff4d4d">BOSS</div>
    <div class="hp-bar"><div id="b-hp" class="hp-fill" style="background:#ff4d4d"></div></div>
    <div id="arena">
        <canvas id="vfx-canvas"></canvas>
        <div id="h-img" class="sprite"></div>
        <div id="b-img" class="sprite"></div>
    </div>
    <div id="h-name" style="color:#00d4ff">HERO</div>
    <div class="hp-bar"><div id="h-hp" class="hp-fill" style="background:#00d4ff"></div></div>
    
    <button class="btn" onclick="attack(20)">NORMAL ATTACK</button>
    <div style="width:85%; display:flex;">
        <button id="btn-ult" class="btn ult-btn" onclick="useUltimate()">ULTIMATE</button>
        <button id="btn-heal" class="btn heal-btn" onclick="useHeal()">HEAL</button>
    </div>
</div>

<div id="ending-screen" class="screen">
    <div class="dialogue-box" style="position: relative; border-color: gold;">
        <h2 style="color: gold;">THE WORLD IS SAVED!</h2>
        <p id="ending-text">David says: "Thank you, Castastics, for protecting my world! Castastics Land is safe once again."</p>
        <button class="btn" onclick="resetProgress()">PLAY AGAIN</button>
    </div>
</div>

<script>
const levels = [
    {id:0, h:"Woody", b:"Mr. Fruit√≥", hI:"woody.png", bI:"fruito.png", hp:100},
    {id:1, h:"James", b:"Radio", hI:"james.png", bI:"radio.png", hp:140},
    {id:2, h:"Ezekiel", b:"Dark Vogue", hI:"ezekiel.png", bI:"vogue.png", hp:200},
    {id:3, h:"Boxlunch", b:"Godzilla", hI:"boxlunch.png", bI:"godzilla.png", hp:400},
    {id:4, h:"Kenny", b:"Carrot", hI:"kenny.png", bI:"carrot.png", hp:250},
    {id:5, h:"The Artist", b:"Covered", hI:"artist.png", bI:"covered.png", hp:300},
    {id:6, h:"Frank", b:"Bookster", hI:"frank.png", bI:"bookster.png", hp:350}
];

const sfx = {
    Woody: "https://assets.mixkit.co/active_storage/sfx/1497/1497-preview.mp3", 
    James: "https://assets.mixkit.co/active_storage/sfx/1922/1922-preview.mp3", 
    Ezekiel: "https://assets.mixkit.co/active_storage/sfx/1188/1188-preview.mp3", 
    Boxlunch: "https://assets.mixkit.co/active_storage/sfx/1152/1152-preview.mp3", 
    Kenny: "https://assets.mixkit.co/active_storage/sfx/1070/1070-preview.mp3", 
    Artist: "https://assets.mixkit.co/active_storage/sfx/1470/1470-preview.mp3", 
    Frank: "https://assets.mixkit.co/active_storage/sfx/1471/1471-preview.mp3",
    Ult: "https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3",
    Heal: "https://assets.mixkit.co/active_storage/sfx/619/619-preview.mp3"
};

let unlocked = parseInt(localStorage.getItem('castasticsProg')) || 0;
let cur, pHp, bHp, busy = false;
let ultUsed = false, healUsed = false;

// RESTORED ORIGINAL DIALOGUE
let storyStep = 0;
const storyLines = [
    "The Castastics Killer has declared war on David's world, Castastics Land...",
    "...by having his minions ruin the world!",
    "But the Castastics have come to fight back! They will not let anything happen to the world David built."
];

function nextStory() {
    if (storyStep < storyLines.length) {
        document.getElementById('story-text').innerText = storyLines[storyStep];
        storyStep++;
    } else {
        sessionStorage.setItem('storySeen', 'true');
        document.getElementById('story-screen').classList.remove('active');
        showMenu();
    }
}

function showMenu() {
    document.getElementById('menu').classList.add('active');
    renderMenu();
}

function renderMenu() {
    const list = document.getElementById('lvl-list');
    list.innerHTML = "";
    levels.forEach((l, idx) => {
        const b = document.createElement('button');
        const lock = idx > unlocked;
        b.className = 'btn' + (lock ? ' locked' : '');
        b.innerHTML = lock ? "üîí LOCKED" : l.h + " VS " + l.b;
        if (!lock) b.onclick = () => startBattle(l);
        list.appendChild(b);
    });
}

function startBattle(l) {
    cur = l; pHp = 100; bHp = 100;
    ultUsed = false; healUsed = false;
    document.getElementById('btn-ult').classList.remove('used');
    document.getElementById('btn-heal').classList.remove('used');
    document.getElementById('h-name').innerText = l.h;
    document.getElementById('b-name').innerText = l.b;
    document.getElementById('h-img').style.backgroundImage = `url(${l.hI})`;
    document.getElementById('b-img').style.backgroundImage = `url(${l.bI})`;
    document.getElementById('menu').classList.remove('active');
    document.getElementById('battle').classList.add('active');
    updateHPBars();
}

function updateHPBars() {
    document.getElementById('h-hp').style.width = Math.max(0, pHp) + "%";
    document.getElementById('b-hp').style.width = Math.max(0, bHp) + "%";
}

function playVFX(type) {
    const canvas = document.getElementById('vfx-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    const bRect = document.getElementById('b-img').getBoundingClientRect();
    const aRect = document.getElementById('arena').getBoundingClientRect();
    const x = bRect.left - aRect.left + 65;
    const y = bRect.top - aRect.top + 65;

    if (type === 'ult') {
        new Audio(sfx.Ult).play();
        document.getElementById('arena').classList.add('flash');
        setTimeout(() => document.getElementById('arena').classList.remove('flash'), 150);
    } else if (type === 'heal') {
        new Audio(sfx.Heal).play();
        document.getElementById('arena').classList.add('heal-flash');
        setTimeout(() => document.getElementById('arena').classList.remove('heal-flash'), 200);
    } else {
        new Audio(sfx[cur.h] || sfx.Woody).play();
    }
    setTimeout(() => ctx.clearRect(0,0, canvas.width, canvas.height), 400);
}

async function attack(dmg) {
    if (busy) return; busy = true;
    playVFX('normal');
    bHp -= (dmg / cur.hp * 100);
    updateHPBars();
    document.getElementById('h-img').style.transform = "translateX(50px)";
    await new Promise(r => setTimeout(r, 400));
    document.getElementById('h-img').style.transform = "translateX(0)";
    if (bHp <= 0) return win();
    bossTurn();
}

async function useUltimate() {
    if (busy || ultUsed) return;
    busy = true; ultUsed = true;
    document.getElementById('btn-ult').classList.add('used');
    playVFX('ult');
    bHp -= (55 / cur.hp * 100);
    updateHPBars();
    await new Promise(r => setTimeout(r, 600));
    if (bHp <= 0) return win();
    bossTurn();
}

async function useHeal() {
    if (busy || healUsed) return;
    busy = true; healUsed = true;
    document.getElementById('btn-heal').classList.add('used');
    playVFX('heal');
    pHp = Math.min(100, pHp + 40);
    updateHPBars();
    await new Promise(r => setTimeout(r, 600));
    bossTurn();
}

async function bossTurn() {
    document.getElementById('b-img').style.transform = "translateX(-50px)";
    document.getElementById('battle').classList.add('shake');
    pHp -= 15;
    updateHPBars();
    await new Promise(r => setTimeout(r, 400));
    document.getElementById('b-img').style.transform = "translateX(0)";
    document.getElementById('battle').classList.remove('shake');
    if (pHp <= 0) { alert("Game Over!"); location.reload(); }
    else { busy = false; }
}

function win() {
    if (cur.id === 6) { document.getElementById('ending-screen').classList.add('active'); }
    else {
        if (cur.id === unlocked) { unlocked++; localStorage.setItem('castasticsProg', unlocked); }
        alert("VICTORY!"); location.reload();
    }
}

function resetProgress() { localStorage.clear(); location.reload(); }

if (!sessionStorage.getItem('storySeen')) { 
    document.getElementById('story-screen').classList.add('active'); 
    nextStory(); 
} else { showMenu(); }
</script>
</body>
</html>
