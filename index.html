<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Castastics Land: The News Battle</title>
    <style>
        body { margin: 0; background: #0a0a0a; color: white; font-family: sans-serif; overflow: hidden; touch-action: manipulation; }
        .screen { display: none; width: 100vw; height: 100vh; flex-direction: column; align-items: center; justify-content: center; position: absolute; }
        .active { display: flex; }

        /* STORY SCREEN */
        #story-screen { background: #000; }
        .dialogue-box { 
            position: absolute; bottom: 30px; width: 90%; 
            background: rgba(0, 0, 0, 0.9); border: 2px solid #00d4ff; border-radius: 15px;
            padding: 20px; box-shadow: 0 0 20px #00d4ff; box-sizing: border-box;
        }

        /* ARENA & VFX */
        #arena { 
            width: 100%; height: 350px; position: relative; overflow: hidden;
            background: linear-gradient(#1a1a2e, #16213e);
            border-bottom: 8px solid #00d4ff; display: flex; justify-content: space-around; align-items: flex-end;
        }
        #vfx-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        .sprite { width: 130px; height: 130px; background-size: contain; background-repeat: no-repeat; background-position: bottom; transition: 0.2s; z-index: 5; }
        .btn { background: #1a1a2e; border: 2px solid #00d4ff; color: white; padding: 15px; margin: 5px; width: 85%; border-radius: 12px; font-weight: bold; }
        .locked { opacity: 0.3; border-color: #444; }
        .hp-bar { width: 90%; height: 12px; background: #333; border-radius: 6px; margin: 5px; overflow: hidden; }
        .hp-fill { height: 100%; width: 100%; transition: 0.4s; }
        
        @keyframes shake { 0% { transform: translate(0); } 25% { transform: translate(5px, 5px); } 50% { transform: translate(-5px, -5px); } 100% { transform: translate(0); } }
        .shake { animation: shake 0.2s infinite; }
    </style>
</head>
<body>

<div id="story-screen" class="screen">
    <div class="dialogue-box">
        <p id="story-text" style="font-size: 18px; line-height: 1.4; min-height: 50px;"></p>
        <button class="btn" onclick="nextStory()" style="width: auto; float: right;">Next</button>
    </div>
</div>

<div id="menu" class="screen">
    <h1 style="color:#00d4ff">CASTASTICS LAND</h1>
    <p>Select Your Hero</p>
    <div id="lvl-list" style="width:100%; display: flex; flex-direction: column; align-items: center;"></div>
    <button class="btn" style="width: 50%; margin-top: 20px; font-size: 10px;" onclick="resetProgress()">RESET ALL PROGRESS</button>
</div>

<div id="battle" class="screen">
    <div id="b-name" style="color:#ff4d4d">BOSS</div>
    <div class="hp-bar"><div id="b-hp" class="hp-fill" style="background:#ff4d4d"></div></div>
    <div id="arena">
        <canvas id="vfx-canvas"></canvas>
        <div id="h-img" class="sprite"></div>
        <div id="b-img" class="sprite"></div>
    </div>
    <div id="h-name" style="color:#00d4ff">HERO</div>
    <div class="hp-bar"><div id="h-hp" class="hp-fill" style="background:#00d4ff"></div></div>
    <p id="log">Battle Start!</p>
    <button class="btn" onclick="attack(20)">ATTACK</button>
</div>

<div id="ending-screen" class="screen">
    <div class="dialogue-box" style="position: relative; border-color: gold;">
        <h2 style="color: gold;">THE WORLD IS SAVED!</h2>
        <p>David Artsy says: "The Castastics have defended the land! Peace is restored."</p>
        <button class="btn" onclick="resetProgress()">PLAY AGAIN</button>
    </div>
</div>

<script>
const levels = [
    {id:0, h:"Woody", b:"Mr. Fruit√≥", hI:"woody.png", bI:"fruito.png", hp:100},
    {id:1, h:"James", b:"Radio", hI:"james.png", bI:"radio.png", hp:120},
    {id:2, h:"Ezekiel", b:"Dark Vogue", hI:"ezekiel.png", bI:"vogue.png", hp:150},
    {id:3, h:"Boxlunch", b:"Godzilla", hI:"boxlunch.png", bI:"godzilla.png", hp:200},
    {id:4, h:"Kenny", b:"Carrot", hI:"kenny.png", bI:"carrot.png", hp:180},
    {id:5, h:"The Artist", b:"Covered", hI:"artist.png", bI:"covered.png", hp:220},
    {id:6, h:"Frank", b:"Bookster", hI:"frank.png", bI:"bookster.png", hp:250}
];

const sfx = {
    Woody: "https://assets.mixkit.co/active_storage/sfx/1497/1497-preview.mp3", 
    James: "https://assets.mixkit.co/active_storage/sfx/1922/1922-preview.mp3", 
    Ezekiel: "https://assets.mixkit.co/active_storage/sfx/1188/1188-preview.mp3", 
    Boxlunch: "https://assets.mixkit.co/active_storage/sfx/1152/1152-preview.mp3", 
    Kenny: "https://assets.mixkit.co/active_storage/sfx/1070/1070-preview.mp3", 
    Artist: "https://assets.mixkit.co/active_storage/sfx/1470/1470-preview.mp3", 
    Frank: "https://assets.mixkit.co/active_storage/sfx/1471/1471-preview.mp3"
};

let unlocked = parseInt(localStorage.getItem('castasticsProg')) || 0;
let cur, pHp, bHp, busy = false;

// STORY LOGIC
let storyStep = 0;
const storyLines = [
    "Castastics Land is under attack by the Killer's minions!",
    "The Rollercoaster has stopped and the ink is spreading...",
    "Only the Castastics can save David's world!"
];

function nextStory() {
    if (storyStep < storyLines.length) {
        document.getElementById('story-text').innerText = storyLines[storyStep];
        storyStep++;
    } else {
        sessionStorage.setItem('storySeen', 'true');
        document.getElementById('story-screen').classList.remove('active');
        showMenu();
    }
}

function showMenu() {
    document.getElementById('menu').classList.add('active');
    renderMenu();
}

function renderMenu() {
    const list = document.getElementById('lvl-list');
    list.innerHTML = "";
    levels.forEach((l, idx) => {
        const b = document.createElement('button');
        const lock = idx > unlocked;
        b.className = 'btn' + (lock ? ' locked' : '');
        b.innerHTML = lock ? "üîí LOCKED" : l.h + " VS " + l.b;
        if (!lock) b.onclick = () => startBattle(l);
        list.appendChild(b);
    });
}

function startBattle(l) {
    cur = l; pHp = 100; bHp = 100;
    document.getElementById('h-name').innerText = l.h;
    document.getElementById('b-name').innerText = l.b;
    document.getElementById('h-img').style.backgroundImage = `url(${l.hI})`;
    document.getElementById('b-img').style.backgroundImage = `url(${l.bI})`;
    document.getElementById('menu').classList.remove('active');
    document.getElementById('battle').classList.add('active');
}

// VFX ENGINE
function playVFX(heroName) {
    const canvas = document.getElementById('vfx-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    const bRect = document.getElementById('b-img').getBoundingClientRect();
    const aRect = document.getElementById('arena').getBoundingClientRect();
    const x = bRect.left - aRect.left + 65;
    const y = bRect.top - aRect.top + 65;

    new Audio(sfx[heroName] || sfx.Woody).play().catch(e => {});

    ctx.lineWidth = 6;
    if (heroName === "Woody") { 
        ctx.strokeStyle = "#8B4513"; ctx.beginPath(); ctx.arc(x, y, 45, 0, Math.PI * 2); ctx.stroke(); 
    } else if (heroName === "James") { 
        ctx.strokeStyle = "cyan"; for(let i=0; i<8; i++) { ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+Math.cos(i)*60, y+Math.sin(i)*60); ctx.stroke(); }
    } else if (heroName === "Ezekiel") { 
        ctx.strokeStyle = "yellow"; ctx.beginPath(); ctx.moveTo(x-50, y-50); ctx.lineTo(x+50, y+50); ctx.stroke();
    } else if (heroName === "Boxlunch") { 
        ctx.strokeStyle = "red"; for(let i=0; i<3; i++) { ctx.beginPath(); ctx.moveTo(x-20+(i*15), y-30); ctx.lineTo(x-40+(i*15), y+30); ctx.stroke(); }
    } else if (heroName === "Kenny") { 
        ctx.fillStyle = "orange"; ctx.beginPath(); ctx.arc(x, y, 30, 0, Math.PI*2); ctx.fill();
    } else if (heroName === "The Artist") { 
        ctx.fillStyle = "magenta"; for(let i=0; i<5; i++) { ctx.beginPath(); ctx.arc(x+Math.random()*40-20, y+Math.random()*40-20, 15, 0, Math.PI*2); ctx.fill(); }
    } else if (heroName === "Frank") { 
        ctx.fillStyle = "black"; ctx.beginPath(); ctx.ellipse(x, y, 50, 30, 0, 0, Math.PI*2); ctx.fill();
    }
    setTimeout(() => ctx.clearRect(0,0, canvas.width, canvas.height), 400);
}

async function attack(dmg) {
    if (busy) return; busy = true;
    playVFX(cur.h);
    
    bHp -= (dmg / cur.hp * 100);
    document.getElementById('b-hp').style.width = Math.max(0, bHp) + "%";
    document.getElementById('h-img').style.transform = "translateX(60px)";
    document.getElementById('battle').classList.add('shake');
    
    await new Promise(r => setTimeout(r, 400));
    document.getElementById('h-img').style.transform = "translateX(0)";
    document.getElementById('battle').classList.remove('shake');
    
    if (bHp <= 0) {
        if (cur.id === 6) { document.getElementById('ending-screen').classList.add('active'); }
        else {
            if (cur.id === unlocked) { unlocked++; localStorage.setItem('castasticsProg', unlocked); }
            alert("VICTORY!"); location.reload();
        }
        return;
    }

    pHp -= 15;
    document.getElementById('h-hp').style.width = Math.max(0, pHp) + "%";
    document.getElementById('b-img').style.transform = "translateX(-60px)";
    await new Promise(r => setTimeout(r, 400));
    document.getElementById('b-img').style.transform = "translateX(0)";
    if (pHp <= 0) { alert("Try Again!"); location.reload(); }
    else { busy = false; }
}

function resetProgress() { localStorage.clear(); location.reload(); }

if (!sessionStorage.getItem('storySeen')) { 
    document.getElementById('story-screen').classList.add('active'); 
    nextStory(); 
} else { showMenu(); }
</script>
</body>
</html>
